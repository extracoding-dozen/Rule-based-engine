# Behavioral Malware Detection Engine

–ü—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π **–¥–≤–∏–∂–æ–∫ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞** –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–æ–≥–æ –ü–û, –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–π –Ω–∞ Python. –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ª–æ–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (Procmon logs `.PML`), –≤—ã—è–≤–ª—è–µ—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —É–≥—Ä–æ–∑—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤.

–í —Ä–∞–º–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞ –±—ã–ª –ø—Ä–æ–≤–µ–¥–µ–Ω –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–≤—É—Ö —Ä–µ–∞–ª—å–Ω—ã—Ö —Å—ç–º–ø–ª–æ–≤ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–æ–≥–æ –ü–û (Ransomware –∏ Stealer), –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—Ç–æ—Ä–æ–≥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏.

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

–°–∏—Å—Ç–µ–º–∞ –∏–º–∏—Ç–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É EDR/AV-–¥–≤–∏–∂–∫–∞, —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É –ø–æ—Å—Ç-–∞–Ω–∞–ª–∏–∑–∞ —Å–æ–±—ã—Ç–∏–π. –û–Ω–∞ —Ä–∞–∑–±–∏—Ä–∞–µ—Ç –ø–æ—Ç–æ–∫ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (–æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ, —Ä–µ–µ—Å—Ç—Ä—É, —Å–µ—Ç–∏, –∑–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤) –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∫ –Ω–∏–º –Ω–∞–±–æ—Ä –¥–µ—Ç–µ–∫—Ç–æ—Ä–æ–≤.

### –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
*   **–ü–∞—Ä—Å–∏–Ω–≥ –ª–æ–≥–æ–≤ Procmon:** –ß—Ç–µ–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–∏–Ω–∞—Ä–Ω—ã—Ö –ª–æ–≥–æ–≤ Process Monitor.
*   **–≠–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã "—Ñ–ª–∞–≥–æ–≤" –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π.
*   **–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** –ê–Ω–∞–ª–∏–∑ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤ –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–º —Ä–µ–∂–∏–º–µ.
*   **–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —É–≥—Ä–æ–∑:** –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –Ω–∞ "–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ" (Suspicious) –∏ "–í—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–µ" (Malicious) —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∞–ª–µ—Ä—Ç–æ–≤.

---

## üîç –ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–æ–≥–æ –ü–û (Research)

–ü–µ—Ä–µ–¥ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º –∫–æ–¥–∞ –±—ã–ª –ø—Ä–æ–≤–µ–¥–µ–Ω —Ä—É—á–Ω–æ–π –∞–Ω–∞–ª–∏–∑ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

### –ö–µ–π—Å 1: Ransomware (–ü—Ä–æ–≥—Ä–∞–º–º–∞-–≤—ã–º–æ–≥–∞—Ç–µ–ª—å)
**–°—ç–º–ø–ª:** `keygen.exe` (–º–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–ª—é—á–µ–π).
**–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (IoB - Indicators of Behavior):**
1.  **–£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤:** –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ `vssadmin.exe Delete Shadows` –∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ `bcdedit`.
2.  **–ú–∞—Å—Å–æ–≤–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ:** –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ–µ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏—Ö –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å.
3.  **–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤:** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è (–≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ `.1c67b99`).
4.  **–°–µ—Ç–µ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (C2):** –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞ –ø–æ—Ä—Ç 443 (HTTPS) –ø–æ —Å–ø–∏—Å–∫—É –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö IP.
5.  **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ `readme.txt` —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º –≤—ã–∫—É–ø–∞ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ–±–æ–µ–≤ —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞ —á–µ—Ä–µ–∑ —Ä–µ–µ—Å—Ç—Ä.

### –ö–µ–π—Å 2: Stealer (–°—Ç–∏–ª–µ—Ä)
**–°—ç–º–ø–ª:** `Adobe-Acrobat-2019-Eng-portable.exe`.
**–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:**
1.  **–î–æ—Å—Ç—É–ø –∫ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º –¥–∞–Ω–Ω—ã–º:** –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –±—Ä–∞—É–∑–µ—Ä–æ–≤ (`cookies.sqlite`, `logins.json`, `key3.db`) –ø–æ –ø—É—Ç—è–º `%AppData%` –∏ `%LocalAppData%`.
2.  **–°–µ—Ç–µ–≤–∞—è —ç–∫—Å—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è:** –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –≤–Ω–µ—à–Ω–∏–π IP (208.91.197.13) —á–µ—Ä–µ–∑ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—Ç.
3.  **–°–∞–º–æ–∑–∞–ø—É—Å–∫:** –ó–∞–ø—É—Å–∫ –¥–æ—á–µ—Ä–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Å —Ç–µ–º –∂–µ –∏–º–µ–Ω–µ–º –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

---

## üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

–î–≤–∏–∂–æ–∫ –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞ Python —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –û–û–ü.

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã:

1.  **`ProcessSource`**: –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω `PMLProcessSource` –¥–ª—è —á—Ç–µ–Ω–∏—è –ª–æ–≥–æ–≤ Procmon.
2.  **`Detector`**: –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –ª–æ–≥–∏–∫–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è.
    *   *`ConcreticRansomwareDetector`*: –†–µ–∞–ª–∏–∑—É–µ—Ç –ª–æ–≥–∏–∫—É –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —à–∏—Ñ—Ä–æ–≤–∞–ª—å—â–∏–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ "—á–µ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤" IP, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π —Ñ–∞–π–ª–æ–≤ –∏ –∫–æ–º–∞–Ω–¥ CMD.
3.  **`Malware`**: –ö–ª–∞—Å—Å-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–æ–π —É–≥—Ä–æ–∑—ã. –•—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ (flags) –∏ —É—Ä–æ–≤–µ–Ω—å –æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
    *   –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —Ñ–ª–∞–≥–æ–≤ (`__ior__`): —á–µ–º –±–æ–ª—å—à–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π —Å–æ–≤–µ—Ä—à–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å, —Ç–µ–º –≤—ã—à–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –≤–µ—Ä–¥–∏–∫—Ç–µ.
4.  **`Analiser`**: –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å–∫–∞–µ—Ç –¥–µ—Ç–µ–∫—Ç–æ—Ä—ã –≤ –ø–æ—Ç–æ–∫–µ –∏ –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.

### –õ–æ–≥–∏–∫–∞ –î–µ—Ç–µ–∫—Ü–∏–∏ (Heuristics Flags)

–î–ª—è Ransomware –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–ª–∞–≥–æ–≤:
*   `MNA` (Malware Network Activity): –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –∏–∑–≤–µ—Å—Ç–Ω—ã–º–∏ C2 —Å–µ—Ä–≤–µ—Ä–∞–º–∏.
*   `MCA` (Malware CMD Activity): –ü–æ–ø—ã—Ç–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–Ω–µ–≤—ã—Ö –∫–æ–ø–∏–π (`vssadmin`, `bcdedit`).
*   `EUF` (Encrypting User Files): –ú–∞—Å—Å–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.
*   `RUF` (Renaming User Files): –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π —Ñ–∞–π–ª–æ–≤.
*   `MRV` (Malware Regedit Values): –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–ª—é—á–µ–π —Ä–µ–µ—Å—Ç—Ä–∞.
*   `WUI` (Writing User Instructions): –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–æ–∫ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º –≤—ã–∫—É–ø–∞.

**–ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è:**
–ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞–±–∏—Ä–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –∫–æ–º–±–∏–Ω–∞—Ü–∏—é —Ñ–ª–∞–≥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `EUF` + `RUF` + `MCA`), –µ–º—É –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å **Blocked** (2). –ü—Ä–∏ –º–µ–Ω–µ–µ —è–≤–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–∞—Ö ‚Äî **SOC Alert** (1).

---

## üöÄ –ó–∞–ø—É—Å–∫ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
*   Python 3.8+
*   –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ `procmon_parser` (–¥–ª—è —á—Ç–µ–Ω–∏—è –±–∏–Ω–∞—Ä–Ω—ã—Ö –ª–æ–≥–æ–≤ PML)

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```python
from detection_engine import ConcreticRansomwareDetector, PMLProcessSource, Analiser

def main():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ —à–∏—Ñ—Ä–æ–≤–∞–ª—å—â–∏–∫–æ–≤
    detector = ConcreticRansomwareDetector()
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–∞ —Å–æ–±—ã—Ç–∏–π (–¥–∞–º–ø Procmon)
    log_source = PMLProcessSource("Logfile_4.PML")
    
    # –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
    analyzer = Analiser(log_source, [detector])
    
    print("–ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞...")
    for malware in analyzer.analize_system():
        if malware.status == 2:
            print(f"[CRITICAL] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:\n{malware}")
        elif malware.status == 1:
            print(f"[WARNING] –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:\n{malware}")

if __name__ == "__main__":
    main()
```
## üõ°Ô∏è –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã
code Text
```
Detected and blocked!!!
The proccess with pid 2312 and name keygen.exe is malicious
Expected type: Agressive ransomware
Process is connecting to malicious hosts
Process is running cmd with malicious arguments (vssadmin delete shadows)
Process is encripting user files
Process is remaiming user files
Process is creating malicious regedit values
Process is writing readmes how to pay foreclosure
```
  

## üîß –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

1. **Language:** Python 3
2. **Analysis Tools:** Sysinternals Process Monitor (Procmon)
3. **Concepts:** Malware Analysis, IoC/IoB Extraction, Heuristic Detection, Multithreading.